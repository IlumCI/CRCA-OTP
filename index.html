<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CR-CA OTP Dashboard</title>
</head>
<body>
  <h1>CR-CA OTP Dashboard</h1>

  <section>
    <h2>Configuration</h2>
    <div>
      <label>API Base URL: 
        <input id="baseUrl" type="text" placeholder="http://localhost:8000" style="width: 300px;" />
      </label>
      <button id="btnSaveConfig">Save Config</button>
    </div>
    <pre id="configOut"></pre>
  </section>

  <hr />

  <section>
    <h2>Health Check</h2>
    <button id="btnHealth">Check Health</button>
    <pre id="healthOut"></pre>
  </section>

  <hr />

  <section>
    <h2>Authentication</h2>
    <div>
      <label>Username: <input id="username" autocomplete="username" /></label><br />
      <label>Password: <input id="password" type="password" autocomplete="current-password" /></label><br />
      <button id="btnLogin">Login</button>
      <button id="btnLogout">Logout</button>
    </div>
    <pre id="authOut"></pre>
  </section>

  <hr />

  <section>
    <h2>Request OTP</h2>
    <div>
      <label>To (email/phone): 
        <input id="otpTo" placeholder="user@example.com or +1234567890" />
      </label><br />
      <label>Channel: 
        <select id="otpChannel">
          <option value="sms">SMS</option>
          <option value="email">Email</option>
          <option value="totp">TOTP</option>
        </select>
      </label><br />
      <label>Purpose: 
        <input id="otpPurpose" placeholder="login" />
      </label><br />
      <button id="btnRequestOtp">Request OTP</button>
      <button id="btnResendOtp">Resend OTP</button>
    </div>
    <pre id="requestOut"></pre>
  </section>

  <hr />

  <section>
    <h2>Verify OTP</h2>
    <div>
      <label>Request ID: <input id="verifyRequestId" placeholder="from request output" /></label><br />
      <label>Code: <input id="verifyCode" inputmode="numeric" placeholder="123456" /></label><br />
      <button id="btnVerifyOtp">Verify OTP</button>
    </div>
    <pre id="verifyOut"></pre>
  </section>

  <hr />

  <section>
    <h2>Operations</h2>
    <div>
      <label>Stats Window: 
        <select id="statsWindow">
          <option value="5m">5 minutes</option>
          <option value="15m" selected>15 minutes</option>
          <option value="1h">1 hour</option>
          <option value="24h">24 hours</option>
        </select>
      </label>
      <button id="btnStats">Get Stats</button>
      <button id="btnRequests">Recent Requests</button>
    </div>
    <pre id="opsOut"></pre>
  </section>

  <hr />

  <section>
    <h2>Console</h2>
    <button id="btnClear">Clear Console</button>
    <pre id="console" style="border: 1px solid #ccc; padding: 10px; max-height: 300px; overflow-y: auto;"></pre>
  </section>

<script>
(() => {
  // Configuration
  const CONFIG_KEY = "crca_otp_config";
  const TOKEN_KEY = "crca_otp_token";
  const REQUEST_ID_KEY = "crca_otp_request_id";

  // State
  let baseUrl = localStorage.getItem(CONFIG_KEY) || "";
  let authToken = localStorage.getItem(TOKEN_KEY) || "";
  let lastRequestId = localStorage.getItem(REQUEST_ID_KEY) || "";

  // Helpers
  const $ = (id) => document.getElementById(id);

  function log(msg) {
    const el = $("console");
    const timestamp = new Date().toISOString();
    const text = typeof msg === "string" ? msg : JSON.stringify(msg, null, 2);
    el.textContent += `[${timestamp}] ${text}\n`;
    el.scrollTop = el.scrollHeight;
  }

  function setOut(id, data) {
    const el = $(id);
    if (!el) return;
    el.textContent = typeof data === "string" ? data : JSON.stringify(data, null, 2);
  }

  function getBaseUrl() {
    const input = $("baseUrl");
    return input ? input.value.trim() || baseUrl : baseUrl;
  }

  async function api(path, options = {}) {
    const { method = "GET", body, auth = true } = options;
    const url = getBaseUrl() + path;
    
    const headers = { "Accept": "application/json" };
    if (body !== undefined) {
      headers["Content-Type"] = "application/json";
    }
    if (auth && authToken) {
      headers["Authorization"] = `Bearer ${authToken}`;
    }

    log(`API ${method} ${url}`);

    try {
      const res = await fetch(url, {
        method,
        headers,
        body: body === undefined ? undefined : JSON.stringify(body),
      });

      const text = await res.text();
      let json;
      try {
        json = text ? JSON.parse(text) : null;
      } catch {
        json = { raw: text };
      }

      if (!res.ok) {
        const err = { status: res.status, statusText: res.statusText, body: json };
        throw err;
      }
      
      log(`Response: ${JSON.stringify(json, null, 2)}`);
      return json;
    } catch (error) {
      log(`Error: ${JSON.stringify(error, null, 2)}`);
      throw error;
    }
  }

  function requireToken() {
    if (!authToken) {
      throw new Error("Not logged in. Please login first.");
    }
  }

  // UI Handlers
  $("btnSaveConfig").onclick = () => {
    const url = $("baseUrl").value.trim();
    if (url) {
      baseUrl = url;
      localStorage.setItem(CONFIG_KEY, baseUrl);
      setOut("configOut", { saved: true, baseUrl: baseUrl });
      log(`Configuration saved: ${baseUrl}`);
    } else {
      setOut("configOut", { error: "Base URL cannot be empty" });
    }
  };

  $("btnHealth").onclick = async () => {
    setOut("healthOut", "");
    try {
      const data = await api("/api/health", { auth: false });
      setOut("healthOut", data);
    } catch (e) {
      setOut("healthOut", e);
    }
  };

  $("btnLogin").onclick = async () => {
    setOut("authOut", "");
    try {
      const username = $("username").value.trim();
      const password = $("password").value;
      
      if (!username || !password) {
        throw new Error("Username and password are required");
      }

      const data = await api("/api/auth/login", {
        method: "POST",
        body: { username, password },
        auth: false,
      });

      if (!data || !data.token) {
        throw new Error("Login response missing token");
      }

      authToken = data.token;
      localStorage.setItem(TOKEN_KEY, authToken);
      setOut("authOut", { success: true, expires_at: data.expires_at });
      log("Login successful");
    } catch (e) {
      setOut("authOut", e);
    }
  };

  $("btnLogout").onclick = async () => {
    setOut("authOut", "");
    try {
      if (authToken) {
        try {
          await api("/api/auth/logout", { method: "POST" });
        } catch (_) {
          // Ignore logout errors
        }
      }
      authToken = "";
      localStorage.removeItem(TOKEN_KEY);
      setOut("authOut", { logout: "ok" });
      log("Logged out");
    } catch (e) {
      setOut("authOut", e);
    }
  };

  $("btnRequestOtp").onclick = async () => {
    setOut("requestOut", "");
    try {
      requireToken();
      const to = $("otpTo").value.trim();
      const channel = $("otpChannel").value;
      const purpose = $("otpPurpose").value.trim() || "login";

      if (!to) {
        throw new Error("'To' field is required");
      }

      const data = await api("/api/otp/request", {
        method: "POST",
        body: { to, channel, purpose },
      });

      setOut("requestOut", data);

      if (data && data.request_id) {
        lastRequestId = data.request_id;
        localStorage.setItem(REQUEST_ID_KEY, lastRequestId);
        $("verifyRequestId").value = lastRequestId;
      }
    } catch (e) {
      setOut("requestOut", e);
    }
  };

  $("btnResendOtp").onclick = async () => {
    setOut("requestOut", "");
    try {
      requireToken();
      const requestId = $("verifyRequestId").value.trim() || lastRequestId;
      
      if (!requestId) {
        throw new Error("Request ID is required");
      }

      const data = await api("/api/otp/resend", {
        method: "POST",
        body: { request_id: requestId },
      });

      setOut("requestOut", data);
    } catch (e) {
      setOut("requestOut", e);
    }
  };

  $("btnVerifyOtp").onclick = async () => {
    setOut("verifyOut", "");
    try {
      requireToken();
      const requestId = $("verifyRequestId").value.trim();
      const code = $("verifyCode").value.trim();

      if (!requestId) {
        throw new Error("Request ID is required");
      }
      if (!code) {
        throw new Error("Code is required");
      }

      const data = await api("/api/otp/verify", {
        method: "POST",
        body: { request_id: requestId, code },
      });

      setOut("verifyOut", data);
    } catch (e) {
      setOut("verifyOut", e);
    }
  };

  $("btnStats").onclick = async () => {
    setOut("opsOut", "");
    try {
      requireToken();
      const window = $("statsWindow").value;
      const data = await api(`/api/stats?window=${encodeURIComponent(window)}`);
      setOut("opsOut", data);
    } catch (e) {
      setOut("opsOut", e);
    }
  };

  $("btnRequests").onclick = async () => {
    setOut("opsOut", "");
    try {
      requireToken();
      const data = await api("/api/requests?limit=50");
      setOut("opsOut", data);
    } catch (e) {
      setOut("opsOut", e);
    }
  };

  $("btnClear").onclick = () => {
    $("console").textContent = "";
    $("healthOut").textContent = "";
    $("authOut").textContent = "";
    $("requestOut").textContent = "";
    $("verifyOut").textContent = "";
    $("opsOut").textContent = "";
    $("configOut").textContent = "";
  };

  // Initialize
  if (baseUrl) {
    $("baseUrl").value = baseUrl;
  }
  if (lastRequestId) {
    $("verifyRequestId").value = lastRequestId;
  }
  if (authToken) {
    log("Token loaded from storage");
  }
})();
</script>
</body>
</html>

